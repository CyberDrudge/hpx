<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<title>Checkpoint</title>
<link rel="stylesheet" href="../../../src/boostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.78.1">
<link rel="home" href="../../../index.html" title="HPX 1.1.0">
<link rel="up" href="../utilities.html" title="Utilities in HPX">
<link rel="prev" href="../utilities.html" title="Utilities in HPX">
<link rel="next" href="../system_components.html" title="HPX System Components">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<table cellpadding="2" width="100%"><tr><td valign="top"><img alt="HPX" width="536" height="100" src="../../../images/hpx_1_1_0.png"></td></tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="../utilities.html"><img src="../../../images/prev.png" alt="Prev"></a><a accesskey="u" href="../utilities.html"><img src="../../../images/up.png" alt="Up"></a><a accesskey="h" href="../../../index.html"><img src="../../../images/home.png" alt="Home"></a><a accesskey="n" href="../system_components.html"><img src="../../../images/next.png" alt="Next"></a>
</div>
<div class="section">
<div class="titlepage"><div><div><h4 class="title">
<a name="hpx.manual.utilities.checkpoint"></a><a class="link" href="checkpoint.html" title="Checkpoint">Checkpoint</a>
</h4></div></div></div>
<p>
          A common need of users is to periodically backup an application. This practice
          provides resiliency and potential restart points in code. We have developed
          the concept of a <code class="literal">checkpoint</code> to support this use case.
        </p>
<p>
          Found in <code class="literal">hpx/util/checkpoint.hpp</code>, <code class="literal">checkpoint</code>s
          are defined as objects which hold a serialized version of an object or
          set of objects at a particular moment in time. This representation can
          be stored in memory for later use or it can be written to disk for storage
          and/or recovery at a later point. In order to create and fill this object
          with data we use a function called <code class="literal">save_checkpoint</code>.
          In code the function looks like this:
        </p>
<pre class="programlisting"><span class="identifier">hpx</span><span class="special">::</span><span class="identifier">future</span><span class="special">&lt;</span><span class="identifier">hpx</span><span class="special">::</span><span class="identifier">util</span><span class="special">::</span><span class="identifier">checkpoint</span><span class="special">&gt;</span> <span class="identifier">hpx</span><span class="special">::</span><span class="identifier">util</span><span class="special">::</span><span class="identifier">save_checkpoint</span><span class="special">(</span><span class="identifier">a</span><span class="special">,</span> <span class="identifier">b</span><span class="special">,</span> <span class="identifier">c</span><span class="special">,</span> <span class="special">...);</span>
</pre>
<p>
          <code class="literal">save_checkpoint</code> takes arbitrary data containers such
          as int, double, float, vector, and future and serializes them into a newly
          created <code class="literal">checkpoint</code> object. This function returns a
          <code class="literal">future</code> to a <code class="literal">checkpoint</code> containing
          the data. Let us look a simple use case below:
        </p>
<pre class="programlisting"><span class="keyword">using</span> <span class="identifier">hpx</span><span class="special">::</span><span class="identifier">util</span><span class="special">::</span><span class="identifier">checkpoint</span><span class="special">;</span>
<span class="keyword">using</span> <span class="identifier">hpx</span><span class="special">::</span><span class="identifier">util</span><span class="special">::</span><span class="identifier">save_checkpoint</span><span class="special">;</span>

<span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="keyword">int</span><span class="special">&gt;</span> <span class="identifier">vec</span><span class="special">{</span><span class="number">1</span><span class="special">,</span><span class="number">2</span><span class="special">,</span><span class="number">3</span><span class="special">,</span><span class="number">4</span><span class="special">,</span><span class="number">5</span><span class="special">};</span>
<span class="identifier">hpx</span><span class="special">::</span><span class="identifier">future</span><span class="special">&lt;</span><span class="identifier">checkpoint</span><span class="special">&gt;</span> <span class="identifier">save_checkpoint</span><span class="special">(</span><span class="identifier">vec</span><span class="special">);</span>
</pre>
<p>
          Once the future is ready the checkpoint object will contain the <code class="literal">vector</code>
          vec and its five elements.
        </p>
<p>
          It is also possible to modify the launch policy used by <code class="literal">save_checkpoint</code>.
          This is accomplished by passing a launch policy as the first argument.
          It is important to note that passing hpx::launch::sync will cause <code class="literal">save_checkpoint</code>
          to return a <code class="literal">checkpoint</code> instead of a <code class="literal">future</code>
          to a <code class="literal">checkpoint</code>. All other policies passed to <code class="literal">save_checkpoint</code>
          will return a <code class="literal">future</code> to a <code class="literal">checkpoint</code>.
        </p>
<p>
          Sometimes <code class="literal">checkpoint</code>s must be declared before they are
          used. <code class="literal">save_checkpoint</code> allows users to move pre-created
          <code class="literal">checkpoint</code>s into the function as long as they are the
          first container passing into the function (In the case where a launch policy
          is used, the <code class="literal">checkpoint</code> will immediately follow the
          launch policy). An example of these features can be found below:
        </p>
<pre class="programlisting"><span class="keyword">char</span> <span class="identifier">character</span> <span class="special">=</span> <span class="char">'d'</span><span class="special">;</span>
<span class="keyword">int</span> <span class="identifier">integer</span> <span class="special">=</span> <span class="number">10</span><span class="special">;</span>
<span class="keyword">float</span> <span class="identifier">flt</span> <span class="special">=</span> <span class="number">10.01f</span><span class="special">;</span>
<span class="keyword">bool</span> <span class="identifier">boolean</span> <span class="special">=</span> <span class="keyword">true</span><span class="special">;</span>
<span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span> <span class="identifier">str</span> <span class="special">=</span> <span class="string">"I am a string of characters"</span><span class="special">;</span>
<span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="keyword">char</span><span class="special">&gt;</span> <span class="identifier">vec</span><span class="special">(</span><span class="identifier">str</span><span class="special">.</span><span class="identifier">begin</span><span class="special">(),</span> <span class="identifier">str</span><span class="special">.</span><span class="identifier">end</span><span class="special">());</span>
<span class="identifier">checkpoint</span> <span class="identifier">archive</span><span class="special">;</span>

<span class="comment">// Test 1</span>
<span class="comment">//  test basic functionality</span>
<span class="identifier">hpx</span><span class="special">::</span><span class="identifier">shared_future</span><span class="special">&lt;</span><span class="identifier">checkpoint</span><span class="special">&gt;</span> <span class="identifier">f_archive</span> <span class="special">=</span> <span class="identifier">save_checkpoint</span><span class="special">(</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(</span><span class="identifier">archive</span><span class="special">),</span> <span class="identifier">character</span><span class="special">,</span> <span class="identifier">integer</span><span class="special">,</span> <span class="identifier">flt</span><span class="special">,</span> <span class="identifier">boolean</span><span class="special">,</span> <span class="identifier">str</span><span class="special">,</span> <span class="identifier">vec</span><span class="special">);</span>
</pre>
<p>
          Now that we can create <code class="literal">checkpoint</code>s we now must be able
          to restore the objects they contain into memory. This is accomplished by
          the function <code class="literal">restore_checkpoint</code>. This function takes
          a <code class="literal">checkpoint</code> and fills its data into the containers
          it is provided. It is important to remember that the containers must be
          ordered in the same way they were placed into the <code class="literal">checkpoint</code>.
          For clarity see the example below:
        </p>
<pre class="programlisting"><span class="keyword">char</span> <span class="identifier">character2</span><span class="special">;</span>
<span class="keyword">int</span> <span class="identifier">integer2</span><span class="special">;</span>
<span class="keyword">float</span> <span class="identifier">flt2</span><span class="special">;</span>
<span class="keyword">bool</span> <span class="identifier">boolean2</span><span class="special">;</span>
<span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span> <span class="identifier">str2</span><span class="special">;</span>
<span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="keyword">char</span><span class="special">&gt;</span> <span class="identifier">vec2</span><span class="special">;</span>

<span class="identifier">restore_checkpoint</span><span class="special">(</span>
    <span class="identifier">f_archive</span><span class="special">.</span><span class="identifier">get</span><span class="special">(),</span> <span class="identifier">character2</span><span class="special">,</span> <span class="identifier">integer2</span><span class="special">,</span> <span class="identifier">flt2</span><span class="special">,</span> <span class="identifier">boolean2</span><span class="special">,</span> <span class="identifier">str2</span><span class="special">,</span> <span class="identifier">vec2</span><span class="special">);</span>
</pre>
<h3>
<a name="hpx.manual.utilities.checkpoint.h0"></a>
          <span class="phrase"><a name="hpx.manual.utilities.checkpoint.checkpoint_i_o"></a></span><a class="link" href="checkpoint.html#hpx.manual.utilities.checkpoint.checkpoint_i_o">Checkpoint
          I/O</a>
        </h3>
<p>
          The core utility of <code class="literal">checkpoint</code> is in its ability to
          make certain data persistent. Often this means that the data is needed
          to be stored in an object, such as a file, for later use. For these cases
          we have provided two solutions: stream operator overloads and access iterators.
        </p>
<p>
          We have created the two stream overloads <code class="literal">operator&lt;&lt;</code>
          and <code class="literal">operator&gt;&gt;</code> to stream data out of and into
          <code class="literal">checkpoint</code>. You can see an example of the overloads
          in use below:
        </p>
<pre class="programlisting"><span class="keyword">double</span> <span class="identifier">a9</span> <span class="special">=</span> <span class="number">1.0</span><span class="special">,</span> <span class="identifier">b9</span> <span class="special">=</span> <span class="number">1.1</span><span class="special">,</span> <span class="identifier">c9</span> <span class="special">=</span> <span class="number">1.2</span><span class="special">;</span>
<span class="identifier">std</span><span class="special">::</span><span class="identifier">ofstream</span> <span class="identifier">test_file_9</span><span class="special">(</span><span class="string">"test_file_9.txt"</span><span class="special">);</span>
<span class="identifier">hpx</span><span class="special">::</span><span class="identifier">future</span><span class="special">&lt;</span><span class="identifier">checkpoint</span><span class="special">&gt;</span> <span class="identifier">f_9</span> <span class="special">=</span> <span class="identifier">save_checkpoint</span><span class="special">(</span><span class="identifier">a9</span><span class="special">,</span> <span class="identifier">b9</span><span class="special">,</span> <span class="identifier">c9</span><span class="special">);</span>
<span class="identifier">test_file_9</span> <span class="special">&lt;&lt;</span> <span class="identifier">f_9</span><span class="special">.</span><span class="identifier">get</span><span class="special">();</span>
<span class="identifier">test_file_9</span><span class="special">.</span><span class="identifier">close</span><span class="special">();</span>

<span class="keyword">double</span> <span class="identifier">a9_1</span><span class="special">,</span> <span class="identifier">b9_1</span><span class="special">,</span> <span class="identifier">c9_1</span><span class="special">;</span>
<span class="identifier">std</span><span class="special">::</span><span class="identifier">ifstream</span> <span class="identifier">test_file_9_1</span><span class="special">(</span><span class="string">"test_file_9.txt"</span><span class="special">);</span>
<span class="identifier">checkpoint</span> <span class="identifier">archive9</span><span class="special">;</span>
<span class="identifier">test_file_9_1</span> <span class="special">&gt;&gt;</span> <span class="identifier">archive9</span><span class="special">;</span>
<span class="identifier">restore_checkpoint</span><span class="special">(</span><span class="identifier">archive9</span><span class="special">,</span> <span class="identifier">a9_1</span><span class="special">,</span> <span class="identifier">b9_1</span><span class="special">,</span> <span class="identifier">c9_1</span><span class="special">);</span>
</pre>
<p>
          This is the primary way to move data into and out of a <code class="literal">checkpoint</code>.
          It is important to note, however, that users should be cautious when using
          a stream operator to load data an another function to remove it (or vice
          versa). Both <code class="literal">operator&lt;&lt;</code> and <code class="literal">operator&gt;&gt;</code>
          rely on a <code class="literal">.write()</code> and a <code class="literal">.read()</code>
          function respectively. In order to know how much data to read from the
          <code class="literal">std::istream</code>, the <code class="literal">operator&lt;&lt;</code>
          will write the size of the <code class="literal">checkpoint</code> before writing
          the <code class="literal">checkpoint</code> data. Correspondingly, the <code class="literal">operator&gt;&gt;</code>
          will read the size of the stored data before reading the data into new
          instance of <code class="literal">checkpoint</code>. As long as the user employs
          the <code class="literal">operator&lt;&lt;</code> and <code class="literal">operator&gt;&gt;</code>
          to stream the data this detail can be ignored.
        </p>
<div class="important"><table border="0" summary="Important">
<tr>
<td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="../../../images/important.png"></td>
<th align="left">Important</th>
</tr>
<tr><td align="left" valign="top"><p>
            Be careful when mixing <code class="literal">operator&lt;&lt;</code> and <code class="literal">operator&gt;&gt;</code>
            with other facilities to read and write to a <code class="literal">checkpoint</code>.
            <code class="literal">operator&lt;&lt;</code> writes and extra variable and <code class="literal">operator&gt;&gt;</code>
            reads this variable back separately. Used together the user will not
            encounter any issues and can safely ignore this detail.
          </p></td></tr>
</table></div>
<p>
          Users may also move the data into and out of a <code class="literal">checkpoint</code>
          using the exposed <code class="literal">.begin()</code> and <code class="literal">.end()</code>
          iterators. An example of this use case is illustrated below.
        </p>
<pre class="programlisting"><span class="identifier">std</span><span class="special">::</span><span class="identifier">ofstream</span> <span class="identifier">test_file_7</span><span class="special">(</span><span class="string">"checkpoint_test_file.txt"</span><span class="special">);</span>
<span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="keyword">float</span><span class="special">&gt;</span> <span class="identifier">vec7</span><span class="special">{</span><span class="number">1.02f</span><span class="special">,</span> <span class="number">1.03f</span><span class="special">,</span> <span class="number">1.04f</span><span class="special">,</span> <span class="number">1.05f</span><span class="special">};</span>
<span class="identifier">hpx</span><span class="special">::</span><span class="identifier">future</span><span class="special">&lt;</span><span class="identifier">checkpoint</span><span class="special">&gt;</span> <span class="identifier">fut_7</span> <span class="special">=</span> <span class="identifier">save_checkpoint</span><span class="special">(</span><span class="identifier">vec7</span><span class="special">);</span>
<span class="identifier">checkpoint</span> <span class="identifier">archive7</span> <span class="special">=</span> <span class="identifier">fut_7</span><span class="special">.</span><span class="identifier">get</span><span class="special">();</span>
<span class="identifier">std</span><span class="special">::</span><span class="identifier">copy</span><span class="special">(</span><span class="identifier">archive7</span><span class="special">.</span><span class="identifier">begin</span><span class="special">()</span>    <span class="comment">// Write data to ofstream</span>
    <span class="special">,</span> <span class="identifier">archive7</span><span class="special">.</span><span class="identifier">end</span><span class="special">()</span>    <span class="comment">// ie. the file</span>
    <span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">ostream_iterator</span><span class="special">&lt;</span><span class="keyword">char</span><span class="special">&gt;(</span><span class="identifier">test_file_7</span><span class="special">));</span>
<span class="identifier">test_file_7</span><span class="special">.</span><span class="identifier">close</span><span class="special">();</span>

<span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="keyword">float</span><span class="special">&gt;</span> <span class="identifier">vec7_1</span><span class="special">;</span>
<span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="keyword">char</span><span class="special">&gt;</span> <span class="identifier">char_vec</span><span class="special">;</span>
<span class="identifier">std</span><span class="special">::</span><span class="identifier">ifstream</span> <span class="identifier">test_file_7_1</span><span class="special">(</span><span class="string">"checkpoint_test_file.txt"</span><span class="special">);</span>
<span class="keyword">if</span> <span class="special">(</span><span class="identifier">test_file_7_1</span><span class="special">)</span>
<span class="special">{</span>
    <span class="identifier">test_file_7_1</span><span class="special">.</span><span class="identifier">seekg</span><span class="special">(</span><span class="number">0</span><span class="special">,</span> <span class="identifier">test_file_7_1</span><span class="special">.</span><span class="identifier">end</span><span class="special">);</span>
    <span class="keyword">int</span> <span class="identifier">length</span> <span class="special">=</span> <span class="identifier">test_file_7_1</span><span class="special">.</span><span class="identifier">tellg</span><span class="special">();</span>
    <span class="identifier">test_file_7_1</span><span class="special">.</span><span class="identifier">seekg</span><span class="special">(</span><span class="number">0</span><span class="special">,</span> <span class="identifier">test_file_7_1</span><span class="special">.</span><span class="identifier">beg</span><span class="special">);</span>
    <span class="identifier">char_vec</span><span class="special">.</span><span class="identifier">resize</span><span class="special">(</span><span class="identifier">length</span><span class="special">);</span>
    <span class="identifier">test_file_7_1</span><span class="special">.</span><span class="identifier">read</span><span class="special">(</span><span class="identifier">char_vec</span><span class="special">.</span><span class="identifier">data</span><span class="special">(),</span> <span class="identifier">length</span><span class="special">);</span>
<span class="special">}</span>
<span class="identifier">checkpoint</span> <span class="identifier">archive7_1</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(</span><span class="identifier">char_vec</span><span class="special">));</span>  <span class="comment">// Write data to checkpoint</span>
<span class="identifier">restore_checkpoint</span><span class="special">(</span><span class="identifier">archive7_1</span><span class="special">,</span> <span class="identifier">vec7_1</span><span class="special">);</span>
</pre>
</div>
<table xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision" width="100%"><tr>
<td align="left"></td>
<td align="right"><div class="copyright-footer">Copyright &#169; 2011-2018 The STE||AR Group
      (http://stellar-group.org)<p>
        Distributed under the Boost Software License, Version 1.0. (See accompanying
        file <a href="http://www.boost.org/LICENSE_1_0.txt" target="_top">LICENSE_1_0.txt</a>
        or copy at <a href="http://www.boost.org/LICENSE_1_0.txt" target="_top">http://www.boost.org/LICENSE_1_0.txt</a>)
      </p>
</div></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="../utilities.html"><img src="../../../images/prev.png" alt="Prev"></a><a accesskey="u" href="../utilities.html"><img src="../../../images/up.png" alt="Up"></a><a accesskey="h" href="../../../index.html"><img src="../../../images/home.png" alt="Home"></a><a accesskey="n" href="../system_components.html"><img src="../../../images/next.png" alt="Next"></a>
</div>
</body>
</html>
