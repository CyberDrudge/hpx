<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<title>Extensions for Task Blocks</title>
<link rel="stylesheet" href="../../../src/boostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.78.1">
<link rel="home" href="../../../index.html" title="HPX 1.2.0">
<link rel="up" href="../parallel.html" title="High Level Parallel Facilities">
<link rel="prev" href="task_block.html" title="Using Task Blocks">
<link rel="next" href="../error_handling.html" title="Error Handling">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<table cellpadding="2" width="100%"><tr><td valign="top"><img alt="HPX" width="567" height="125" src="../../../images/hpx_1_2_0_draft.png"></td></tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="task_block.html"><img src="../../../images/prev.png" alt="Prev"></a><a accesskey="u" href="../parallel.html"><img src="../../../images/up.png" alt="Up"></a><a accesskey="h" href="../../../index.html"><img src="../../../images/home.png" alt="Home"></a><a accesskey="n" href="../error_handling.html"><img src="../../../images/next.png" alt="Next"></a>
</div>
<div class="section">
<div class="titlepage"><div><div><h4 class="title">
<a name="hpx.manual.parallel.task_block0"></a><a class="link" href="task_block0.html" title="Extensions for Task Blocks">Extensions for Task
        Blocks</a>
</h4></div></div></div>
<h6>
<a name="hpx.manual.parallel.task_block0.h0"></a>
          <span class="phrase"><a name="hpx.manual.parallel.task_block0.using_execution_policies_with_ta"></a></span><a class="link" href="task_block0.html#hpx.manual.parallel.task_block0.using_execution_policies_with_ta">Using
          Execution Policies with Task Blocks</a>
        </h6>
<p>
          In <span class="emphasis"><em>HPX</em></span> we implemented some extensions for <code class="computeroutput"><span class="identifier">task_block</span></code> beyond the actual standards
          proposal <a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2015/n4411.pdf" target="_top">N4411</a>.
          The main addition is that a <code class="computeroutput"><span class="identifier">task_block</span></code>
          can be invoked with a execution policy as its first argument, very similar
          to the parallel algorithms.
        </p>
<p>
          An execution policy is an object that expresses the requirements on the
          ordering of functions invoked as a consequence of the invocation of a task
          block. Enabling passing an execution policy to <code class="computeroutput"><span class="identifier">define_task_block</span></code>
          gives the user control over the amount of parallelism employed by the created
          <code class="computeroutput"><span class="identifier">task_block</span></code>. In the following
          example the use of an explicit <code class="computeroutput"><span class="identifier">par</span></code>
          execution policy makes the user's intent explicit:
        </p>
<pre class="programlisting"><span class="keyword">template</span> <span class="special">&lt;</span><span class="keyword">typename</span> <span class="identifier">Func</span><span class="special">&gt;</span>
<span class="keyword">int</span> <span class="identifier">traverse</span><span class="special">(</span><span class="identifier">node</span> <span class="special">*</span><span class="identifier">n</span><span class="special">,</span> <span class="identifier">Func</span><span class="special">&amp;&amp;</span> <span class="identifier">compute</span><span class="special">)</span>
<span class="special">{</span>
    <span class="keyword">int</span> <span class="identifier">left</span> <span class="special">=</span> <span class="number">0</span><span class="special">,</span> <span class="identifier">right</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span>

    <span class="identifier">define_task_block</span><span class="special">(</span>
        <span class="identifier">execution</span><span class="special">::</span><span class="identifier">par</span><span class="special">,</span>                <span class="comment">// execution::parallel_policy</span>
        <span class="special">[&amp;](</span><span class="identifier">task_block</span><span class="special">&lt;&gt;&amp;</span> <span class="identifier">tb</span><span class="special">)</span> <span class="special">{</span>
            <span class="keyword">if</span> <span class="special">(</span><span class="identifier">n</span><span class="special">-&gt;</span><span class="identifier">left</span><span class="special">)</span>
                <span class="identifier">tb</span><span class="special">.</span><span class="identifier">run</span><span class="special">([&amp;]</span> <span class="special">{</span> <span class="identifier">left</span> <span class="special">=</span> <span class="identifier">traverse</span><span class="special">(</span><span class="identifier">n</span><span class="special">-&gt;</span><span class="identifier">left</span><span class="special">,</span> <span class="identifier">compute</span><span class="special">);</span> <span class="special">});</span>
            <span class="keyword">if</span> <span class="special">(</span><span class="identifier">n</span><span class="special">-&gt;</span><span class="identifier">right</span><span class="special">)</span>
                <span class="identifier">tb</span><span class="special">.</span><span class="identifier">run</span><span class="special">([&amp;]</span> <span class="special">{</span> <span class="identifier">right</span> <span class="special">=</span> <span class="identifier">traverse</span><span class="special">(</span><span class="identifier">n</span><span class="special">-&gt;</span><span class="identifier">right</span><span class="special">,</span> <span class="identifier">compute</span><span class="special">);</span> <span class="special">});</span>
        <span class="special">});</span>

    <span class="keyword">return</span> <span class="identifier">compute</span><span class="special">(</span><span class="identifier">n</span><span class="special">)</span> <span class="special">+</span> <span class="identifier">left</span> <span class="special">+</span> <span class="identifier">right</span><span class="special">;</span>
<span class="special">}</span>
</pre>
<p>
          This also causes the <code class="computeroutput"><a class="link" href="../../parallel/v2/task_block.html" title="Class template task_block">hpx::parallel::task_block</a></code> object to be a
          template in our implementation. The template argument is the type of the
          execution policy used to create the task block. The template argument defaults
          to <code class="computeroutput"><a class="link" href="../../parallel/execution/parallel_policy.html" title="Struct parallel_policy">hpx::parallel::execution::parallel_policy</a></code>.
        </p>
<p>
          <span class="emphasis"><em>HPX</em></span> still supports calling <code class="computeroutput"><a class="link" href="../../parallel/v2/define__idm140508685111056.html" title="Function template define_task_block">hpx::parallel::define_task_block</a></code> without
          an explicit execution policy. In this case the task block will run using
          the <code class="computeroutput"><a class="link" href="../../parallel/execution/parallel_policy.html" title="Struct parallel_policy">hpx::parallel::execution::parallel_policy</a></code>.
        </p>
<p>
          <span class="emphasis"><em>HPX</em></span> also adds the ability to access the execution
          policy which was used to create a given <code class="computeroutput"><span class="identifier">task_block</span></code>.
        </p>
<h6>
<a name="hpx.manual.parallel.task_block0.h1"></a>
          <span class="phrase"><a name="hpx.manual.parallel.task_block0.using_executors_to_run_tasks"></a></span><a class="link" href="task_block0.html#hpx.manual.parallel.task_block0.using_executors_to_run_tasks">Using
          Executors to run Tasks</a>
        </h6>
<p>
          Often, we want to be able to not only define an execution policy to use
          by default for all spawned tasks inside the task block, but in addition
          to customize the execution context for one of the tasks executed by <code class="computeroutput"><span class="identifier">task_block</span><span class="special">::</span><span class="identifier">run</span></code>. Adding an optionally passed executor
          instance to that function enables this use case:
        </p>
<pre class="programlisting"><span class="keyword">template</span> <span class="special">&lt;</span><span class="keyword">typename</span> <span class="identifier">Func</span><span class="special">&gt;</span>
<span class="keyword">int</span> <span class="identifier">traverse</span><span class="special">(</span><span class="identifier">node</span> <span class="special">*</span><span class="identifier">n</span><span class="special">,</span> <span class="identifier">Func</span><span class="special">&amp;&amp;</span> <span class="identifier">compute</span><span class="special">)</span>
<span class="special">{</span>
    <span class="keyword">int</span> <span class="identifier">left</span> <span class="special">=</span> <span class="number">0</span><span class="special">,</span> <span class="identifier">right</span> <span class="special">=</span> <span class="number">0</span><span class="special">;</span>

    <span class="identifier">define_task_block</span><span class="special">(</span>
        <span class="identifier">execution</span><span class="special">::</span><span class="identifier">par</span><span class="special">,</span>                <span class="comment">// execution::parallel_policy</span>
        <span class="special">[&amp;](</span><span class="keyword">auto</span><span class="special">&amp;</span> <span class="identifier">tb</span><span class="special">)</span> <span class="special">{</span>
            <span class="keyword">if</span> <span class="special">(</span><span class="identifier">n</span><span class="special">-&gt;</span><span class="identifier">left</span><span class="special">)</span>
            <span class="special">{</span>
                <span class="comment">// use explicitly specified executor to run this task</span>
                <span class="identifier">tb</span><span class="special">.</span><span class="identifier">run</span><span class="special">(</span><span class="identifier">my_executor</span><span class="special">(),</span> <span class="special">[&amp;]</span> <span class="special">{</span> <span class="identifier">left</span> <span class="special">=</span> <span class="identifier">traverse</span><span class="special">(</span><span class="identifier">n</span><span class="special">-&gt;</span><span class="identifier">left</span><span class="special">,</span> <span class="identifier">compute</span><span class="special">);</span> <span class="special">});</span>
            <span class="special">}</span>
            <span class="keyword">if</span> <span class="special">(</span><span class="identifier">n</span><span class="special">-&gt;</span><span class="identifier">right</span><span class="special">)</span>
            <span class="special">{</span>
                <span class="comment">// use the executor associated with the par execution policy</span>
                <span class="identifier">tb</span><span class="special">.</span><span class="identifier">run</span><span class="special">([&amp;]</span> <span class="special">{</span> <span class="identifier">right</span> <span class="special">=</span> <span class="identifier">traverse</span><span class="special">(</span><span class="identifier">n</span><span class="special">-&gt;</span><span class="identifier">right</span><span class="special">,</span> <span class="identifier">compute</span><span class="special">);</span> <span class="special">});</span>
            <span class="special">}</span>
        <span class="special">});</span>

    <span class="keyword">return</span> <span class="identifier">compute</span><span class="special">(</span><span class="identifier">n</span><span class="special">)</span> <span class="special">+</span> <span class="identifier">left</span> <span class="special">+</span> <span class="identifier">right</span><span class="special">;</span>
<span class="special">}</span>
</pre>
<p>
          <span class="emphasis"><em>HPX</em></span> still supports calling <code class="computeroutput">hpx::parallel::task_block::run</code> without an explicit
          executor object. In this case the task will be run using the executor associated
          with the execution policy which was used to call <code class="computeroutput"><a class="link" href="../../parallel/v2/define__idm140508685111056.html" title="Function template define_task_block">hpx::parallel::define_task_block</a></code>.
        </p>
</div>
<table xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision" width="100%"><tr>
<td align="left"></td>
<td align="right"><div class="copyright-footer">Copyright &#169; 2011-2018 The STE||AR Group
      (http://stellar-group.org)<p>
        Distributed under the Boost Software License, Version 1.0. (See accompanying
        file <a href="http://www.boost.org/LICENSE_1_0.txt" target="_top">LICENSE_1_0.txt</a>
        or copy at <a href="http://www.boost.org/LICENSE_1_0.txt" target="_top">http://www.boost.org/LICENSE_1_0.txt</a>)
      </p>
</div></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="task_block.html"><img src="../../../images/prev.png" alt="Prev"></a><a accesskey="u" href="../parallel.html"><img src="../../../images/up.png" alt="Up"></a><a accesskey="h" href="../../../index.html"><img src="../../../images/home.png" alt="Home"></a><a accesskey="n" href="../error_handling.html"><img src="../../../images/next.png" alt="Next"></a>
</div>
</body>
</html>
